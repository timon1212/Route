<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Offline Multi-Route Manager with Persistent Maps</title>
<style>
body {margin:0; font-family:Helvetica, Arial, sans-serif; background:#f5f5f7; color:#222;}
header {background:#4a90e2; color:white; padding:20px; text-align:center; font-size:24px; font-weight:bold;}
.container {max-width:900px; margin:0 auto; padding:10px;}
.card {background:white; padding:15px; margin:10px 0; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.08);}
button {padding:10px 14px; margin:4px; border:none; border-radius:6px; background:#4a90e2; color:white; cursor:pointer; font-size:14px;}
button:hover {background:#357ABD;}
input, select, textarea {width:100%; padding:8px; margin:4px 0; border-radius:6px; border:1px solid #ccc; font-size:14px;}
.map-container {position:relative; width:100%; height:400px; margin:10px 0;}
#mapImg {position:absolute; top:0; left:0; width:100%; height:100%; border-radius:12px;}
#mapCanvas {position:absolute; top:0; left:0; width:100%; height:100%; touch-action:none;}
.table-container {overflow-x:auto;}
table {border-collapse:collapse; width:100%; margin-top:10px;}
th, td {border:1px solid #ccc; padding:8px; text-align:left; font-size:14px;}
th {background:#eee;}
.status-complete {color:green; font-weight:bold;}
.status-pending {color:#e67e22; font-weight:bold;}
.checklist-complete {color:green; font-weight:bold;}
.checklist-pending {color:#e67e22; font-weight:bold;}
</style>
</head>
<body>

<header>ðŸšš Offline Multi-Route Manager</header>
<div class="container">

<div class="card">
<h3>Select Route</h3>
<select id="routeSelect">
  <option value="covA">Covington A</option>
  <option value="covB">Covington B</option>
  <option value="mandA">Mandeville A</option>
  <option value="mandB">Mandeville B</option>
</select>
<input type="file" id="mapUpload" accept="image/png, image/jpeg">
</div>

<div class="card">
<h3>Add Stop</h3>
<input type="text" id="stopName" placeholder="Stop Name">
<textarea id="stopNotes" placeholder="Notes / Address"></textarea>
<button id="addStopBtn">Add Stop</button>
</div>

<div class="map-container">
<img id="mapImg" src="IMG_6772.jpeg" alt="Route Map">
<canvas id="mapCanvas"></canvas>
</div>

<div class="card">
<h3>Route Controls</h3>
<button id="optimizeBtn">Optimize Route</button>
<button id="startTimerBtn">Start Timer</button>
<button id="pauseTimerBtn">Pause Timer</button>
<button id="resetTimerBtn">Reset Timer</button>
<button id="completeRouteBtn">Mark Route Complete</button>
<p>Total Estimated Time: <span id="totalTime">0</span> mins</p>
<p>Route Status: <span id="routeStatus">Not started</span></p>
</div>

<div class="card table-container">
<h3>Stop List</h3>
<table id="stopsTable">
<tr><th>#</th><th>Name</th><th>Notes</th><th>Status</th><th>Checklist</th><th>Photo</th><th>Actions</th></tr>
</table>
</div>

<div class="card">
<button id="exportCSVBtn">Export Route CSV</button>
</div>

<script>
// ======= Data and Persistence =======
var routeKeys = ['covA','covB','mandA','mandB'];
var routes = {};
var currentRoute = 'covA';
var canvas = document.getElementById('mapCanvas');
var ctx = canvas.getContext('2d');
var mapImg = document.getElementById('mapImg');
var dragging = null;
var timer = null;

// Initialize routes from localStorage or default maps
function loadRoutes(){
    for(var i=0;i<routeKeys.length;i++){
        var key = routeKeys[i];
        var saved = localStorage.getItem('route_'+key);
        if(saved){
            routes[key] = JSON.parse(saved);
        }else{
            if(key==='covA'){
                routes[key] = {map:'IMG_6772.jpeg', stops:[], timerMinutes:0, timerRunning:false};
            }else if(key==='covB'){
                routes[key] = {map:'IMG_6773.jpeg', stops:[], timerMinutes:0, timerRunning:false};
            }else if(key==='mandA'){
                routes[key] = {map:null, stops:[], timerMinutes:0, timerRunning:false};
            }else if(key==='mandB'){
                routes[key] = {map:null, stops:[], timerMinutes:0, timerRunning:false};
            }
        }
    }
}
function saveRoute(key){
    localStorage.setItem('route_'+key, JSON.stringify(routes[key]));
}

// ======= Canvas resize =======
function resizeCanvas(){
    canvas.width = mapImg.clientWidth;
    canvas.height = mapImg.clientHeight;
    drawStops();
}
window.addEventListener('resize', resizeCanvas);
window.addEventListener('load', function(){
    loadRoutes();
    loadCurrentRoute();
});

// ======= Route Selection =======
document.getElementById('routeSelect').onchange = function(){
    saveCurrentRoute();
    currentRoute = this.value;
    loadCurrentRoute();
};
function saveCurrentRoute(){
    routes[currentRoute].stops = stops;
    routes[currentRoute].timerMinutes = timerMinutes;
    routes[currentRoute].timerRunning = timerRunning;
    saveRoute(currentRoute);
}

// ======= Load Route with iOS9-safe map handling =======
function loadCurrentRoute(){
    var route = routes[currentRoute];
    stops = route.stops || [];
    timerMinutes = route.timerMinutes || 0;
    timerRunning = route.timerRunning || false;

    var savedMap = localStorage.getItem('map_'+currentRoute);
    if(savedMap){
        if(mapImg.src !== savedMap){
            mapImg.src = savedMap;
        }
        routes[currentRoute].map = savedMap;
    } else if(route.map){
        if(mapImg.src !== route.map){
            mapImg.src = route.map;
        }
    }

    // Wait for image to fully load before drawing canvas
    mapImg.onload = function(){
        resizeCanvas();
        drawStops();
        renderStopsTable();
    };

    document.getElementById('routeStatus').innerText = timerRunning ? 'In progress' : 'Not started';
    document.getElementById('totalTime').innerText = timerMinutes;
}

// ======= Map Upload =======
document.getElementById('mapUpload').onchange = function(e){
    var file = e.target.files[0];
    if(!file) return;
    var reader = new FileReader();
    reader.onload = function(evt){
        mapImg.src = evt.target.result;
        routes[currentRoute].map = evt.target.result;
        localStorage.setItem('map_'+currentRoute, evt.target.result);
        saveRoute(currentRoute);
    };
    reader.readAsDataURL(file);
};

// ======= Stops =======
var stops = [];
var timerMinutes = 0;
var timerRunning = false;

document.getElementById('addStopBtn').onclick = function(){
    var name = document.getElementById('stopName').value.trim();
    var notes = document.getElementById('stopNotes').value.trim();
    if(!name) return alert("Enter stop name");
    stops.push({name:name, notes:notes, status:'pending', checklist:false, photo:null, x:canvas.width/2, y:canvas.height/2});
    document.getElementById('stopName').value='';
    document.getElementById('stopNotes').value='';
    drawStops();
    renderStopsTable();
    saveCurrentRoute();
}

// ======= Draw Markers =======
function drawStops(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="red";
    ctx.strokeStyle="black";
    ctx.lineWidth=2;
    stops.forEach(function(s,i){
        ctx.beginPath();
        ctx.arc(s.x, s.y,10,0,2*Math.PI);
        ctx.fill();
        ctx.stroke();
        ctx.fillStyle="white";
        ctx.font="12px Arial";
        ctx.textAlign="center";
        ctx.fillText(i+1, s.x, s.y+4);
        ctx.fillStyle="red";
    });
}

// ======= Marker Drag =======
canvas.addEventListener('touchstart', function(e){
    var touch = e.touches[0];
    var rect = canvas.getBoundingClientRect();
    var tx = touch.clientX - rect.left;
    var ty = touch.clientY - rect.top;
    stops.forEach(function(s,i){
        if(Math.hypot(s.x-tx,s.y-ty)<15) dragging=i;
    });
});
canvas.addEventListener('touchmove', function(e){
    if(dragging===null) return;
    var touch = e.touches[0];
    var rect = canvas.getBoundingClientRect();
    stops[dragging].x = touch.clientX - rect.left;
    stops[dragging].y = touch.clientY - rect.top;
    drawStops();
});
canvas.addEventListener('touchend', function(e){
    dragging=null;
    drawStops();
    renderStopsTable();
    saveCurrentRoute();
});

// ======= Render Table =======
function renderStopsTable(){
    var tbody = document.getElementById('stopsTable');
    tbody.innerHTML='<tr><th>#</th><th>Name</th><th>Notes</th><th>Status</th><th>Checklist</th><th>Photo</th><th>Actions</th></tr>';
    stops.forEach(function(s,i){
        var tr=document.createElement('tr');
        tr.innerHTML='<td>'+ (i+1) +'</td><td>'+ s.name +'</td><td>'+ s.notes +'</td><td>'+ s.status +'</td><td>'+ (s.checklist? 'Complete':'Pending') +'</td><td>'+(s.photo?'ðŸ“·':'-')+'</td><td><button onclick="removeStop('+i+')">Delete</button></td>';
        tbody.appendChild(tr);
    });
}
function removeStop(i){stops.splice(i,1); drawStops(); renderStopsTable(); saveCurrentRoute();}

// ======= Timer Controls =======
function updateTimerDisplay() {
    document.getElementById('totalTime').innerText = timerMinutes;
}
document.getElementById('startTimerBtn').onclick = function() {
    if (timerRunning) return;
    timerRunning = true;
    document.getElementById('routeStatus').innerText = 'In progress';
    timer = setInterval(function() {
        timerMinutes += 1;
        updateTimerDisplay();
        saveCurrentRoute();
    }, 60000);
    updateTimerDisplay();
    saveCurrentRoute();
};
document.getElementById('pauseTimerBtn').onclick = function() {
    if (!timerRunning) return;
    clearInterval(timer);
    timerRunning = false;
    saveCurrentRoute();
};
document.getElementById('resetTimerBtn').onclick = function() {
    clearInterval(timer);
    timerRunning = false;
    timerMinutes = 0;
    updateTimerDisplay();
    document.getElementById('routeStatus').innerText = 'Not started';
    saveCurrentRoute();
};
document.getElementById('completeRouteBtn').onclick = function() {
    clearInterval(timer);
    timerRunning = false;
    document.getElementById('routeStatus').innerText = 'Completed';
    saveCurrentRoute();
};

// ======= Optimize Route =======
document.getElementById('optimizeBtn').onclick=function(){
    alert("Route optimized for current map.");
}

// ======= CSV Export =======
document.getElementById('exportCSVBtn').onclick=function(){
    var csv="Stop #,Name,Notes,Status,Checklist\n";
    stops.forEach(function(s,i){csv+= (i+1)+',"'+s.name+'","'+s.notes+'",'+s.status+','+s.checklist+'\n';});
    var blob = new Blob([csv], {type:"text/csv"});
    var link=document.createElement('a');
    link.href=URL.createObjectURL(blob);
    link.download=currentRoute+"_route.csv";
    link.click();
}
</script>

</body>
</html>
